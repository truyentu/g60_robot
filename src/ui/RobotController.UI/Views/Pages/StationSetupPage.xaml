<UserControl x:Class="RobotController.UI.Views.Pages.StationSetupPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:models="clr-namespace:RobotController.UI.Models"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="900"
             Background="{StaticResource SecondaryBackground}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Object List -->
        <Border Grid.Column="0" Background="{StaticResource PrimaryBackground}"
                Margin="0,0,10,0" Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="0,0,0,10">
                    <TextBlock Text="Environment Objects" FontSize="16" FontWeight="Bold"
                               Foreground="{StaticResource ForegroundBrush}"/>
                    <TextBlock Foreground="Gray" FontSize="11" Margin="0,5,0,0"
                               Text="{Binding Objects.Count, StringFormat='{}{0} object(s) in scene'}"/>

                    <!-- Robot Base Height Info -->
                    <Border Background="#D0D0D0" CornerRadius="4" Padding="8,5" Margin="0,8,0,0">
                        <TextBlock Text="{Binding RobotBaseHeightInfo}" Foreground="#4FC3F7"
                                   FontSize="11" FontWeight="SemiBold"/>
                    </Border>
                </StackPanel>

                <!-- Object List -->
                <ListBox Grid.Row="1" ItemsSource="{Binding Objects}"
                         SelectedItem="{Binding SelectedObject}"
                         Background="Transparent" BorderThickness="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource PrimaryBackground}"
                                    BorderBrush="{StaticResource BorderBrush}"
                                    BorderThickness="1" CornerRadius="4"
                                    Padding="10" Margin="0,0,0,5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"
                                                       Foreground="{StaticResource ForegroundBrush}"/>
                                            <!-- Category badge -->
                                            <Border CornerRadius="3" Padding="4,1" Margin="6,0,0,0"
                                                    Background="#555" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Category}" FontSize="9"
                                                           Foreground="#AAA"/>
                                            </Border>
                                        </StackPanel>
                                        <TextBlock FontSize="10" Foreground="Gray" Margin="0,3,0,0">
                                            <Run Text="Pos: ("/>
                                            <Run Text="{Binding X, StringFormat=F1}"/>
                                            <Run Text=", "/>
                                            <Run Text="{Binding Y, StringFormat=F1}"/>
                                            <Run Text=", "/>
                                            <Run Text="{Binding Z, StringFormat=F1}"/>
                                            <Run Text=")"/>
                                        </TextBlock>
                                        <TextBlock FontSize="10" Foreground="Gray">
                                            <Run Text="Frame: "/>
                                            <Run Text="{Binding ParentFrameName}"/>
                                        </TextBlock>
                                    </StackPanel>

                                    <!-- Color indicator -->
                                    <Border Grid.Column="1" Width="16" Height="16" CornerRadius="8"
                                            VerticalAlignment="Center">
                                        <Border.Background>
                                            <SolidColorBrush Color="{Binding Color}"/>
                                        </Border.Background>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <!-- Buttons -->
                <StackPanel Grid.Row="2" Margin="0,10,0,0">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="Import STL" Command="{Binding ImportObjectCommand}"
                                Background="{StaticResource AccentBrush}" Foreground="#222222"
                                Padding="15,5" Margin="0,0,5,0"/>
                        <Button Content="Delete" Command="{Binding DeleteObjectCommand}"
                                IsEnabled="{Binding SelectedObject, Converter={StaticResource NotNullToBool}}"
                                Padding="15,5" Margin="0,0,5,0"/>
                        <Button Content="Edit" Command="{Binding StartEditObjectCommand}"
                                IsEnabled="{Binding SelectedObject, Converter={StaticResource NotNullToBool}}"
                                Padding="15,5"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Button Content="Save Station" Command="{Binding SaveStationCommand}"
                                Padding="15,5" Margin="0,0,5,0"/>
                        <Button Content="Load Station" Command="{Binding LoadStationCommand}"
                                Padding="15,5" Margin="0,0,5,0"/>
                        <Button Content="Refresh Frames" Command="{Binding RefreshFramesCommand}"
                                Padding="15,5"/>
                    </StackPanel>

                    <!-- Snap-to-Grid -->
                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                        <CheckBox Content="Snap to Grid" IsChecked="{Binding IsSnapToGridEnabled}"
                                  Foreground="{StaticResource ForegroundBrush}" VerticalAlignment="Center"
                                  Margin="0,0,8,0"/>
                        <ComboBox ItemsSource="{Binding AvailableGridSizes}"
                                  SelectedItem="{Binding GridSize}"
                                  Width="65" VerticalAlignment="Center"
                                  IsEnabled="{Binding IsSnapToGridEnabled}"/>
                        <TextBlock Text="mm" Foreground="Gray" FontSize="10"
                                   VerticalAlignment="Center" Margin="4,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Right Panel: Object Editor -->
        <Border Grid.Column="1" Background="{StaticResource PrimaryBackground}" Padding="15">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock Text="Object Properties" FontSize="16" FontWeight="Bold"
                               Foreground="{StaticResource ForegroundBrush}" Margin="0,0,0,15"/>

                    <!-- No selection message (visible when not editing) -->
                    <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibility}}">
                        <TextBlock Text="Select an object to edit its properties, or import a new STL file."
                                   Foreground="Gray" FontSize="13"/>
                        <TextBlock Text="Click an object in the 3D viewport to select it."
                                   Foreground="Gray" FontSize="11" Margin="0,5,0,0"/>
                        <TextBlock Text="Drag: move XY | Shift+Drag: move Z | Grid: snap positions"
                                   Foreground="#777" FontSize="10" Margin="0,3,0,0"/>
                    </StackPanel>

                    <!-- Editor (when editing) -->
                    <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibility}}">

                        <!-- Name -->
                        <TextBlock Text="Name" Foreground="Gray" FontSize="11"/>
                        <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,3,0,10"/>

                        <!-- Category -->
                        <TextBlock Text="Category" FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}" Margin="0,0,0,5"/>
                        <ComboBox ItemsSource="{Binding AvailableCategories}"
                                  SelectedItem="{Binding EditCategory}"
                                  Width="200" HorizontalAlignment="Left" Margin="0,0,0,5"/>
                        <TextBlock Text="Pedestal objects auto-snap to XY origin"
                                   Foreground="Gray" FontSize="10" Margin="0,0,0,10"/>

                        <!-- Position -->
                        <TextBlock Text="Position (mm)" FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}" Margin="0,0,0,10"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Margin="0,0,10,10">
                                <TextBlock Text="X" Foreground="Gray" FontSize="11"/>
                                <TextBox Text="{Binding EditX, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="0,0,10,10">
                                <TextBlock Text="Y" Foreground="Gray" FontSize="11"/>
                                <TextBox Text="{Binding EditY, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="0,0,0,10">
                                <TextBlock Text="Z" Foreground="Gray" FontSize="11"/>
                                <TextBox Text="{Binding EditZ, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                        </Grid>

                        <!-- Quick Placement Actions -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,3">
                            <Button Content="Drop to Ground" Command="{Binding DropToGroundCommand}"
                                    Background="#555" Foreground="#222222" FontSize="11"
                                    Padding="10,4" Margin="0,0,5,0" ToolTip="Set Z so object bottom sits on ground (Z=0)"/>
                            <Button Content="Align to Robot Base" Command="{Binding AlignToRobotBaseCommand}"
                                    Background="#555" Foreground="#222222" FontSize="11"
                                    Padding="10,4" Margin="0,0,5,0" ToolTip="Set Z so object top aligns with robot base height"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <Button Content="Drop to Table" Command="{Binding DropToTableCommand}"
                                    Background="#8B6914" Foreground="#222222" FontSize="11"
                                    Padding="10,4" Margin="0,0,5,0"
                                    ToolTip="Set Z so object bottom sits on top of the welding table surface"/>
                        </StackPanel>

                        <!-- Height Info -->
                        <Border Background="#1E3A5F" CornerRadius="4" Padding="8,5" Margin="0,0,0,10"
                                Visibility="{Binding HasHeightInfo, Converter={StaticResource BoolToVisibility}}">
                            <TextBlock Text="{Binding SelectedObjectHeightInfo}" Foreground="#B0D4F1"
                                       FontSize="10" TextWrapping="Wrap"/>
                        </Border>

                        <!-- Rotation -->
                        <TextBlock Text="Rotation (degrees)" FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}" Margin="0,5,0,5"/>

                        <!-- Quick Flip (90° rotations) -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <TextBlock Text="Quick:" Foreground="Gray" FontSize="11"
                                       VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <Button Content="Flip X" Command="{Binding FlipXCommand}"
                                    Background="#8B0000" Foreground="#222222" FontSize="10"
                                    Padding="8,3" Margin="0,0,3,0"
                                    ToolTip="Rotate +90° around X axis"/>
                            <Button Content="Flip Y" Command="{Binding FlipYCommand}"
                                    Background="#006400" Foreground="#222222" FontSize="10"
                                    Padding="8,3" Margin="0,0,3,0"
                                    ToolTip="Rotate +90° around Y axis"/>
                            <Button Content="Flip Z" Command="{Binding FlipZCommand}"
                                    Background="#00008B" Foreground="#222222" FontSize="10"
                                    Padding="8,3"
                                    ToolTip="Rotate +90° around Z axis"/>
                        </StackPanel>

                        <!-- Rotation Snap -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <CheckBox Content="Snap" IsChecked="{Binding IsRotationSnapEnabled}"
                                      Foreground="{StaticResource ForegroundBrush}"
                                      VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <ComboBox ItemsSource="{Binding AvailableRotationSnaps}"
                                      SelectedItem="{Binding RotationSnapIncrement}"
                                      Width="50" VerticalAlignment="Center"
                                      IsEnabled="{Binding IsRotationSnapEnabled}"/>
                            <TextBlock Text="°" Foreground="Gray" FontSize="11"
                                       VerticalAlignment="Center" Margin="3,0,0,0"/>
                        </StackPanel>

                        <!-- Preset Orientations -->
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Presets:" Foreground="Gray" FontSize="11" Margin="0,0,0,3"/>
                            <WrapPanel>
                                <Button Content="Flat" CommandParameter="Flat"
                                        Command="{Binding ApplyPresetOrientationCommand}"
                                        Background="#444" Foreground="#222222" FontSize="10"
                                        Padding="8,3" Margin="0,0,3,3"/>
                                <Button Content="Stand X" CommandParameter="StandX"
                                        Command="{Binding ApplyPresetOrientationCommand}"
                                        Background="#444" Foreground="#222222" FontSize="10"
                                        Padding="8,3" Margin="0,0,3,3"/>
                                <Button Content="Stand Y" CommandParameter="StandY"
                                        Command="{Binding ApplyPresetOrientationCommand}"
                                        Background="#444" Foreground="#222222" FontSize="10"
                                        Padding="8,3" Margin="0,0,3,3"/>
                                <Button Content="Tilt 45°" CommandParameter="Tilt45"
                                        Command="{Binding ApplyPresetOrientationCommand}"
                                        Background="#444" Foreground="#222222" FontSize="10"
                                        Padding="8,3" Margin="0,0,3,3"/>
                                <Button Content="Flip 180°" CommandParameter="UpsideDown"
                                        Command="{Binding ApplyPresetOrientationCommand}"
                                        Background="#444" Foreground="#222222" FontSize="10"
                                        Padding="8,3" Margin="0,0,3,3"/>
                                <Button Content="Rot 90°" CommandParameter="Rotate90"
                                        Command="{Binding ApplyPresetOrientationCommand}"
                                        Background="#444" Foreground="#222222" FontSize="10"
                                        Padding="8,3" Margin="0,0,3,3"/>
                            </WrapPanel>
                        </StackPanel>

                        <!-- Rx, Ry, Rz fields -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Margin="0,0,10,10">
                                <TextBlock Text="Rx" Foreground="Gray" FontSize="11"/>
                                <TextBox Text="{Binding EditRx, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="0,0,10,10">
                                <TextBlock Text="Ry" Foreground="Gray" FontSize="11"/>
                                <TextBox Text="{Binding EditRy, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="0,0,0,10">
                                <TextBlock Text="Rz" Foreground="Gray" FontSize="11"/>
                                <TextBox Text="{Binding EditRz, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                        </Grid>

                        <!-- Scale -->
                        <TextBlock Text="Scale" FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}" Margin="0,5,0,10"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding EditScale, UpdateSourceTrigger=PropertyChanged}"/>
                            <TextBlock Grid.Column="1" Text="(1.0 = original, 1000 = m→mm)"
                                       Foreground="Gray" FontSize="10" VerticalAlignment="Center" Margin="10,0,0,0"/>
                        </Grid>

                        <!-- Color -->
                        <TextBlock Text="Color" FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}" Margin="0,15,0,5"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <!-- Gray -->
                            <Border Width="28" Height="28" CornerRadius="14" Margin="0,0,6,0"
                                    Background="#A0A0A0" Cursor="Hand" BorderThickness="2"
                                    BorderBrush="Transparent"
                                    MouseLeftButtonDown="ColorPreset_Click" Tag="#A0A0A0"/>
                            <!-- Steel Blue -->
                            <Border Width="28" Height="28" CornerRadius="14" Margin="0,0,6,0"
                                    Background="#4682B4" Cursor="Hand" BorderThickness="2"
                                    BorderBrush="Transparent"
                                    MouseLeftButtonDown="ColorPreset_Click" Tag="#4682B4"/>
                            <!-- Orange -->
                            <Border Width="28" Height="28" CornerRadius="14" Margin="0,0,6,0"
                                    Background="#FF8C00" Cursor="Hand" BorderThickness="2"
                                    BorderBrush="Transparent"
                                    MouseLeftButtonDown="ColorPreset_Click" Tag="#FF8C00"/>
                            <!-- Green -->
                            <Border Width="28" Height="28" CornerRadius="14" Margin="0,0,6,0"
                                    Background="#228B22" Cursor="Hand" BorderThickness="2"
                                    BorderBrush="Transparent"
                                    MouseLeftButtonDown="ColorPreset_Click" Tag="#228B22"/>
                            <!-- Red -->
                            <Border Width="28" Height="28" CornerRadius="14" Margin="0,0,6,0"
                                    Background="#DC143C" Cursor="Hand" BorderThickness="2"
                                    BorderBrush="Transparent"
                                    MouseLeftButtonDown="ColorPreset_Click" Tag="#DC143C"/>
                            <!-- Yellow -->
                            <Border Width="28" Height="28" CornerRadius="14" Margin="0,0,6,0"
                                    Background="#FFD700" Cursor="Hand" BorderThickness="2"
                                    BorderBrush="Transparent"
                                    MouseLeftButtonDown="ColorPreset_Click" Tag="#FFD700"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Selected: " Foreground="Gray" FontSize="10"/>
                            <Border Width="14" Height="14" CornerRadius="7">
                                <Border.Background>
                                    <SolidColorBrush Color="{Binding EditColor}"/>
                                </Border.Background>
                            </Border>
                        </StackPanel>

                        <!-- Parent Frame -->
                        <TextBlock Text="Parent Frame" FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}" Margin="0,15,0,10"/>
                        <ComboBox ItemsSource="{Binding AvailableFrames}"
                                  SelectedItem="{Binding EditParentFrame}"
                                  Width="200" HorizontalAlignment="Left"/>
                        <TextBlock Text="Objects parented to a frame move when the frame moves"
                                   Foreground="Gray" FontSize="10" Margin="0,5,0,0"/>

                        <!-- Apply/Cancel -->
                        <StackPanel Orientation="Horizontal" Margin="0,20,0,0">
                            <Button Content="Apply" Command="{Binding ApplyTransformCommand}"
                                    Background="{StaticResource AccentBrush}" Foreground="#222222"
                                    Padding="20,8" Margin="0,0,10,0"/>
                            <Button Content="Cancel" Command="{Binding CancelEditCommand}"
                                    Padding="20,8"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Error message -->
                    <Border Background="#F44336" CornerRadius="4" Padding="10" Margin="0,15,0,0"
                            Visibility="{Binding HasError, Converter={StaticResource BoolToVisibility}}">
                        <TextBlock Text="{Binding ErrorMessage}" Foreground="#222222" TextWrapping="Wrap"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>
