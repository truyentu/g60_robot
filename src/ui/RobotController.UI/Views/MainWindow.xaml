<Window x:Class="RobotController.UI.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:helix="http://helix-toolkit.org/wpf"
        xmlns:vm="clr-namespace:RobotController.UI.ViewModels"
        xmlns:controls="clr-namespace:RobotController.UI.Views.Controls"
        xmlns:pages="clr-namespace:RobotController.UI.Views.Pages"
        xmlns:layout="clr-namespace:RobotController.UI.Views.Layout"
        mc:Ignorable="d"
        Title="Robot Controller"
        Height="768" Width="1024"
        MinHeight="600" MinWidth="800"
        Background="#C0C0C0"
        WindowStartupLocation="CenterScreen"
        SnapsToDevicePixels="True"
        UseLayoutRounding="True">

    <!-- ================================================================ -->
    <!-- ROOT LAYOUT: 4-Row KUKA SmartHMI Teach Pendant Shell             -->
    <!--                                                                  -->
    <!-- Row 0: Top Status Bar (modular UserControl)                      -->
    <!-- Row 1: Message/Alarm Banner (modular UserControl)                -->
    <!-- Row 2: Main Workspace (Viewport + Navigator + Pages)             -->
    <!-- Row 3: Bottom Softkeys (modular UserControl)                     -->
    <!-- ================================================================ -->
    <Grid Background="#C0C0C0">
        <Grid.RowDefinitions>
            <RowDefinition Height="40"/>   <!-- Status Bar -->
            <RowDefinition Height="28"/>   <!-- Message Banner -->
            <RowDefinition Height="*"/>    <!-- Main Workspace -->
            <RowDefinition Height="52"/>   <!-- Bottom Softkeys -->
        </Grid.RowDefinitions>

        <!-- ============================================================ -->
        <!-- ROW 0: TOP STATUS BAR (Modular UserControl)                  -->
        <!-- ============================================================ -->
        <layout:TopStatusBarView Grid.Row="0"/>

        <!-- ============================================================ -->
        <!-- ROW 1: MESSAGE BANNER (Modular UserControl)                  -->
        <!-- ============================================================ -->
        <layout:MessageBannerView Grid.Row="1"/>

        <!-- ============================================================ -->
        <!-- ROW 2: MAIN WORKSPACE                                        -->
        <!-- ContentControl for dynamic page loading                      -->
        <!-- Currently hosts: Navigator sidebar + Viewport + Page content -->
        <!-- ============================================================ -->
        <Grid Grid.Row="2" Background="#C8C8C8">
            <!-- Content Area: Viewport + Pages -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>                   <!-- Viewport + Pages -->
                    <ColumnDefinition Width="Auto"/>                <!-- Splitter -->
                    <ColumnDefinition Width="200" MinWidth="160"/>  <!-- Properties Panel -->
                    <ColumnDefinition Width="Auto"/>                <!-- KUKA Right Status Column -->
                </Grid.ColumnDefinitions>

                <!-- Left: Navigator (split) + 3D Viewport -->
                <Grid Grid.Column="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition x:Name="NavigatorColumn" Width="0"/>
                        <ColumnDefinition x:Name="NavSplitterColumn" Width="0"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Navigator Panel (visible when NavIndex == 9, controlled by code-behind) -->
                    <pages:NavigatorView Grid.Column="0" x:Name="NavigatorPanel"
                                         DataContext="{Binding NavigatorVm}"
                                         HorizontalAlignment="Stretch"
                                         Visibility="Collapsed">
                    </pages:NavigatorView>

                    <!-- Navigator/Viewport Splitter -->
                    <GridSplitter Grid.Column="1" Width="3" Background="#AAAAAA"
                                  HorizontalAlignment="Stretch"
                                  x:Name="NavSplitter" Visibility="Collapsed">
                    </GridSplitter>

                    <!-- Viewport + Pages (Column 2) -->
                    <Grid Grid.Column="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>    <!-- Viewport -->
                        <RowDefinition Height="Auto"/> <!-- UDP Monitor (collapsible) -->
                    </Grid.RowDefinitions>

                    <!-- 3D Viewport -->
                    <Border Grid.Row="0" Background="#E0E0E0" BorderBrush="#999999" BorderThickness="0,0,0,1">
                        <helix:HelixViewport3D x:Name="Viewport3D"
                                               Background="#E0E0E0"
                                               ShowCoordinateSystem="True"
                                               CoordinateSystemLabelForeground="Black"
                                               ZoomExtentsWhenLoaded="True"
                                               CameraRotationMode="Turntable"
                                               RotateAroundMouseDownPoint="True"
                                               ZoomAroundMouseDownPoint="True"
                                               ZoomSensitivity="0.5"
                                               MouseLeftButtonDown="Viewport3D_MouseLeftButtonDown"
                                               MouseMove="Viewport3D_MouseMove"
                                               MouseLeftButtonUp="Viewport3D_MouseLeftButtonUp"
                                               IsRotationEnabled="True"
                                               IsPanEnabled="True"
                                               IsZoomEnabled="True"
                                               ShowViewCube="True"
                                               ViewCubeBackText="Back"
                                               ViewCubeFrontText="Front"
                                               ViewCubeLeftText="Left"
                                               ViewCubeRightText="Right"
                                               ViewCubeTopText="Top"
                                               ViewCubeBottomText="Bottom">
                            <helix:HelixViewport3D.Camera>
                                <PerspectiveCamera Position="1500,1500,1000"
                                                   LookDirection="-1,-1,-0.5"
                                                   UpDirection="0,0,1"
                                                   FieldOfView="45"/>
                            </helix:HelixViewport3D.Camera>
                            <ModelVisual3D x:Name="LightingModel">
                                <ModelVisual3D.Content>
                                    <Model3DGroup>
                                        <AmbientLight Color="#808080"/>
                                        <DirectionalLight Color="#D0D0D0" Direction="-1,-1,-1"/>
                                        <DirectionalLight Color="#909090" Direction="1,0.5,0.5"/>
                                    </Model3DGroup>
                                </ModelVisual3D.Content>
                            </ModelVisual3D>
                            <helix:GridLinesVisual3D x:Name="GridLines"
                                                     Width="2000" Length="2000"
                                                     MajorDistance="500" MinorDistance="100"
                                                     Thickness="1" Fill="#AAAAAA"/>
                            <helix:CoordinateSystemVisual3D x:Name="CoordAxes" ArrowLengths="200"/>
                            <ModelVisual3D x:Name="RobotModelVisual"/>
                            <ModelVisual3D x:Name="TcpMarkerVisual"/>
                            <ModelVisual3D x:Name="TcpTraceVisual"/>
                            <ModelVisual3D x:Name="SceneObjectsVisual"/>
                            <ModelVisual3D x:Name="BaseFrameAxesVisual"/>
                            <ModelVisual3D x:Name="TcpGizmoVisual"/>
                            <ModelVisual3D x:Name="GhostRobotVisual"/>
                        </helix:HelixViewport3D>
                    </Border>

                    <!-- TCP Pick Mode Banner (overlay on viewport) -->
                    <Border Grid.Row="0" x:Name="TcpPickBanner" VerticalAlignment="Top" HorizontalAlignment="Stretch"
                            Background="#CC2196F3" Padding="15,10" Margin="20,10,20,0"
                            Visibility="Collapsed" SnapsToDevicePixels="True">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="Click on the tool mesh to pick TCP point"
                                       Foreground="White" FontSize="14" FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                            <Button Content="Cancel" Margin="20,0,0,0" Padding="12,4"
                                    Click="CancelTcpPick_Click"
                                    Style="{StaticResource IndustrialButton}"
                                    Background="#33FFFFFF" Foreground="White"/>
                        </StackPanel>
                    </Border>

                    <!-- UDP Monitor Toggle Button Overlay -->
                    <Button Grid.Row="0"
                            HorizontalAlignment="Right" VerticalAlignment="Bottom"
                            Margin="0,0,130,130"
                            Command="{Binding ToggleUdpMonitorCommand}"
                            Cursor="Hand" Panel.ZIndex="10"
                            ToolTip="Toggle UDP Packet Monitor">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="0">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="Bd" Background="#CC3A3A3A" BorderBrush="#5A5A5A"
                                        BorderThickness="1" Padding="10,6" CornerRadius="4">
                                    <StackPanel Orientation="Horizontal">
                                        <Ellipse Width="10" Height="10" Margin="0,0,6,0">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Fill" Value="#888888"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ShowUdpMonitor}" Value="True">
                                                            <Setter Property="Fill" Value="#4EC9B0"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                        <TextBlock Text="UDP"
                                                   Foreground="#222222" FontSize="11" FontFamily="Consolas"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="#CC555555"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>

                    <!-- STM32 Connect Button Overlay (above E-STOP) -->
                    <Button Grid.Row="0"
                            HorizontalAlignment="Right" VerticalAlignment="Bottom"
                            Margin="0,0,20,130"
                            Command="{Binding ShowStm32DialogCommand}"
                            Cursor="Hand" Panel.ZIndex="10"
                            ToolTip="Connect to STM32 Firmware (Ethernet UDP)">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="0">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="Bd" Background="#CC3A3A3A" BorderBrush="#5A5A5A"
                                        BorderThickness="1" Padding="10,6" CornerRadius="4">
                                    <StackPanel Orientation="Horizontal">
                                        <Ellipse Width="10" Height="10" Margin="0,0,6,0">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Fill" Value="#888888"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsStm32Connected}" Value="True">
                                                            <Setter Property="Fill" Value="#4EC9B0"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                        <TextBlock Text="{Binding Stm32StatusText, FallbackValue='STM32'}"
                                                   Foreground="#222222" FontSize="11" FontFamily="Segoe UI"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="#CC555555"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>

                    <!-- E-STOP Button Overlay -->
                    <Button Grid.Row="0"
                            Width="100" Height="100"
                            HorizontalAlignment="Right" VerticalAlignment="Bottom"
                            Margin="0,0,20,20"
                            Command="{Binding TriggerEStopCommand}"
                            Cursor="Hand" Panel.ZIndex="10">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="0">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Grid>
                                    <Ellipse Fill="#40000000" Margin="4,4,-4,-4"/>
                                    <Ellipse x:Name="ButtonBody" Fill="{Binding EStopButtonColor}">
                                        <Ellipse.Effect>
                                            <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="3"/>
                                        </Ellipse.Effect>
                                    </Ellipse>
                                    <Ellipse Stroke="#80000000" StrokeThickness="4" Margin="8"/>
                                    <Ellipse Margin="12">
                                        <Ellipse.Fill>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                <GradientStop Color="#40FFFFFF" Offset="0"/>
                                                <GradientStop Color="Transparent" Offset="0.5"/>
                                            </LinearGradientBrush>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <TextBlock Text="{Binding EStopButtonText}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               FontWeight="Bold" FontSize="11" Foreground="White"
                                               TextAlignment="Center" TextWrapping="Wrap" Width="70"/>
                                </Grid>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="ButtonBody" Property="Fill" Value="#FF6666"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter TargetName="ButtonBody" Property="Fill" Value="#CC0000"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>

                    <!-- Page Content Overlay (covers viewport for non-Teach pages) -->
                    <Border x:Name="PageContentOverlay" Grid.Row="0" Background="#C8C8C8">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="2">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="3">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="4">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="5">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="6">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="7">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SelectedNavIndex}" Value="8">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>

                        <Grid>
                            <pages:IOView DataContext="{Binding IoViewModel}">
                                <pages:IOView.Style>
                                    <Style TargetType="pages:IOView">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="2">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </pages:IOView.Style>
                            </pages:IOView>

                            <pages:ConfigurationView DataContext="{Binding ConfigurationViewModel}">
                                <pages:ConfigurationView.Style>
                                    <Style TargetType="pages:ConfigurationView">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="3">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </pages:ConfigurationView.Style>
                            </pages:ConfigurationView>

                            <pages:DiagnosticsView DataContext="{Binding DiagnosticsViewModel}">
                                <pages:DiagnosticsView.Style>
                                    <Style TargetType="pages:DiagnosticsView">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="4">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </pages:DiagnosticsView.Style>
                            </pages:DiagnosticsView>

                            <pages:RobotPackageBrowser DataContext="{Binding RobotCatalogViewModel}">
                                <pages:RobotPackageBrowser.Style>
                                    <Style TargetType="pages:RobotPackageBrowser">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="5">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </pages:RobotPackageBrowser.Style>
                            </pages:RobotPackageBrowser>

                            <pages:UrdfImportPage DataContext="{Binding UrdfImportViewModel}">
                                <pages:UrdfImportPage.Style>
                                    <Style TargetType="pages:UrdfImportPage">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="6">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </pages:UrdfImportPage.Style>
                            </pages:UrdfImportPage>

                            <controls:ToolPanel DataContext="{Binding Tool}">
                                <controls:ToolPanel.Style>
                                    <Style TargetType="controls:ToolPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="7">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:ToolPanel.Style>
                            </controls:ToolPanel>
                        </Grid>
                    </Border>

                    <!-- Program Editor (covers viewport when NavIndex == 1) -->
                    <controls:ProgramEditor Grid.Row="0" DataContext="{Binding ProgramEditor}">
                        <controls:ProgramEditor.Style>
                            <Style TargetType="controls:ProgramEditor">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="1">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </controls:ProgramEditor.Style>
                    </controls:ProgramEditor>

                    <!-- UDP Packet Monitor Panel (Row 1, collapsible) -->
                    <Border Grid.Row="1" Background="#D0D0D0" BorderBrush="#AAAAAA" BorderThickness="0,2,0,0"
                            Height="220" DataContext="{Binding DiagnosticsViewModel}">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DataContext.ShowUdpMonitor, RelativeSource={RelativeSource AncestorType=Window}}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="28"/>
                                <RowDefinition Height="20"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="20"/>
                            </Grid.RowDefinitions>

                            <!-- Toolbar -->
                            <Border Grid.Row="0" Background="#C8C8C8" Padding="4,2">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="UDP PACKETS" Foreground="#4EC9B0" FontWeight="Bold"
                                               FontSize="11" FontFamily="Consolas" VerticalAlignment="Center" Margin="4,0,12,0"/>
                                    <Button Command="{Binding ToggleCaptureCommand}"
                                            Background="#555555" Foreground="#222222" BorderThickness="0"
                                            FontSize="10" Padding="8,2" Margin="0,0,4,0" Cursor="Hand"
                                            FontFamily="Consolas">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Content" Value="Stop"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsCapturing}" Value="False">
                                                        <Setter Property="Content" Value="Capture"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <Button Content="Clear" Command="{Binding ClearPacketsCommand}"
                                            Background="#555555" Foreground="#222222" BorderThickness="0"
                                            FontSize="10" Padding="8,2" Margin="0,0,8,0" Cursor="Hand"
                                            FontFamily="Consolas"/>
                                    <TextBlock Text="Filter:" Foreground="#666666" FontSize="10"
                                               VerticalAlignment="Center" Margin="0,0,4,0" FontFamily="Consolas"/>
                                    <ComboBox Width="60" SelectedIndex="0"
                                              Background="#444" Foreground="#222222" FontSize="10"
                                              FontFamily="Consolas" BorderThickness="0"
                                              SelectionChanged="UdpFilterCombo_SelectionChanged">
                                        <ComboBoxItem Content="All" IsSelected="True"/>
                                        <ComboBoxItem Content="TX"/>
                                        <ComboBoxItem Content="RX"/>
                                    </ComboBox>
                                    <TextBlock Foreground="#4EC9B0" FontSize="10" Margin="12,0,0,0"
                                               VerticalAlignment="Center" FontFamily="Consolas">
                                        <Run Text="TX:"/><Run Text="{Binding TxCount, Mode=OneWay}"/>
                                    </TextBlock>
                                    <TextBlock Foreground="#B5CEA8" FontSize="10" Margin="8,0,0,0"
                                               VerticalAlignment="Center" FontFamily="Consolas">
                                        <Run Text="RX:"/><Run Text="{Binding RxCount, Mode=OneWay}"/>
                                    </TextBlock>
                                    <!-- Close button -->
                                    <Button Content="X" Margin="12,0,0,0" Padding="6,0"
                                            Command="{Binding DataContext.ToggleUdpMonitorCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            Background="Transparent" Foreground="#666666" BorderThickness="0"
                                            FontSize="11" FontWeight="Bold" Cursor="Hand" FontFamily="Consolas"/>
                                </StackPanel>
                            </Border>

                            <!-- Column Headers -->
                            <Border Grid.Row="1" Background="#BEBEBE" Padding="4,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="35"/>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="40"/>
                                        <ColumnDefinition Width="40"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="TIME" Foreground="#666666" FontSize="9" FontFamily="Consolas" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="DIR" Foreground="#666666" FontSize="9" FontFamily="Consolas" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="TYPE" Foreground="#666666" FontSize="9" FontFamily="Consolas" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="3" Text="SEQ" Foreground="#666666" FontSize="9" FontFamily="Consolas" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="4" Text="LEN" Foreground="#666666" FontSize="9" FontFamily="Consolas" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="5" Text="PAYLOAD HEX" Foreground="#666666" FontSize="9" FontFamily="Consolas" VerticalAlignment="Center"/>
                                </Grid>
                            </Border>

                            <!-- Packet List -->
                            <ListBox Grid.Row="2" ItemsSource="{Binding UdpPackets}"
                                     Background="Transparent" BorderThickness="0"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                                     VirtualizingPanel.IsVirtualizing="True">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="4,1"/>
                                        <Setter Property="Margin" Value="0"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListBoxItem">
                                                    <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#40FFFFFF"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="80"/>
                                                <ColumnDefinition Width="35"/>
                                                <ColumnDefinition Width="100"/>
                                                <ColumnDefinition Width="40"/>
                                                <ColumnDefinition Width="40"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Time}" Foreground="#555555" FontSize="10" FontFamily="Consolas"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Dir}" FontSize="10" FontFamily="Consolas">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Foreground" Value="#B5CEA8"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Dir}" Value="TX">
                                                                <Setter Property="Foreground" Value="#4EC9B0"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBlock Grid.Column="2" Text="{Binding TypeName}" Foreground="#222222" FontSize="10" FontFamily="Consolas" FontWeight="SemiBold"/>
                                            <TextBlock Grid.Column="3" Text="{Binding Seq}" Foreground="#555555" FontSize="10" FontFamily="Consolas"/>
                                            <TextBlock Grid.Column="4" Text="{Binding Len}" Foreground="#555555" FontSize="10" FontFamily="Consolas"/>
                                            <TextBlock Grid.Column="5" Text="{Binding Hex}" Foreground="#CE9178" FontSize="10" FontFamily="Consolas"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <!-- Status Bar -->
                            <Border Grid.Row="3" Background="#BEBEBE" Padding="4,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontSize="9" Foreground="#666666" FontFamily="Consolas" VerticalAlignment="Center">
                                        <Run Text="Packets: "/><Run Text="{Binding UdpPackets.Count, Mode=OneWay}"/>
                                    </TextBlock>
                                    <TextBlock FontSize="9" FontFamily="Consolas" VerticalAlignment="Center" Margin="12,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="#4EC9B0"/>
                                                <Setter Property="Text" Value="Status: Capturing"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsCapturing}" Value="False">
                                                        <Setter Property="Foreground" Value="#888"/>
                                                        <Setter Property="Text" Value="Status: Stopped"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Border>
                </Grid>
                </Grid>

                <!-- Right Splitter -->
                <GridSplitter Grid.Column="1" Width="3" Background="#AAAAAA"
                              HorizontalAlignment="Center" VerticalAlignment="Stretch"/>

                <!-- Properties Panel (right side) â€” KUKA SmartPAD Style -->
                <Border Grid.Column="2" Background="#C8C8C8"
                        BorderBrush="#999999" BorderThickness="1,0,0,0">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="1">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="2">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="3">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="4">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="5">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="6">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="7">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="8">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <controls:KukaJogPanel/>
                </Border>

                <!-- Station Setup Panel (Index 8) -->
                <pages:StationSetupPage Grid.Column="2" DataContext="{Binding StationSetup}">
                    <pages:StationSetupPage.Style>
                        <Style TargetType="pages:StationSetupPage">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.SelectedNavIndex, RelativeSource={RelativeSource AncestorType=Window}}" Value="8">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </pages:StationSetupPage.Style>
                </pages:StationSetupPage>

                <!-- ======================================================== -->
                <!-- KUKA Right Status Column (Column 3)                       -->
                <!-- Status indicators + Close (X) button â€” KUKA KSS 8.3 Â§4.2 -->
                <!-- ======================================================== -->
                <Border Grid.Column="3" Background="#CCCCCC" BorderBrush="#999999" BorderThickness="1,0,0,0" Width="48">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="1">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="2">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="3">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="4">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="5">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="6">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="7">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedNavIndex}" Value="8">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <StackPanel VerticalAlignment="Top">
                        <!-- Robot Status Icon -->
                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,2,2,0" ToolTip="Robot Status">
                            <TextBlock Text="ðŸ¤–" FontSize="20" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>

                        <!-- Drives Status -->
                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,1,2,0" ToolTip="Drives Status">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <Ellipse Width="10" Height="10" Fill="{Binding DrivesStatusColor}" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding DrivesStatusSymbol}" Foreground="#222222" FontSize="10"
                                           FontWeight="Bold" HorizontalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Interpreter Status -->
                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,1,2,0" ToolTip="Robot Interpreter">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <Ellipse Width="10" Height="10" Fill="{Binding RobotInterpreterColor}" HorizontalAlignment="Center"/>
                                <TextBlock Text="R" Foreground="#222222" FontSize="10"
                                           FontWeight="Bold" HorizontalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Separator -->
                        <Rectangle Fill="#AAAAAA" Height="2" Margin="4,4,4,4"/>

                        <!-- CLOSE PAGE BUTTON (Orange X) â€” KUKA Style -->
                        <Button Command="{Binding ClosePageCommand}" Cursor="Hand"
                                ToolTip="Close Window" Height="44" Margin="2,0,2,2">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="XBtnBorder" Background="#EB6A0A" SnapsToDevicePixels="True">
                                        <TextBlock Text="âœ•" FontSize="22" FontWeight="Bold"
                                                   Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="XBtnBorder" Property="Background" Value="#FF7B1B"/>
                                        </Trigger>
                                        <Trigger Property="IsPressed" Value="True">
                                            <Setter TargetName="XBtnBorder" Property="Background" Value="#CC5500"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>

                        <!-- Separator -->
                        <Rectangle Fill="#AAAAAA" Height="2" Margin="4,2,4,4"/>

                        <!-- Tool/Base Indicator -->
                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,0,2,1" ToolTip="Active Tool">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <TextBlock Text="T" Foreground="#EB6A0A" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding ActiveToolDisplay}" Foreground="#222222" FontSize="9"
                                           HorizontalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Border>

                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,0,2,1" ToolTip="Active Base">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <TextBlock Text="B" Foreground="#4EC9B0" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding ActiveBaseDisplay}" Foreground="#222222" FontSize="9"
                                           HorizontalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Override Indicator -->
                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,0,2,1" ToolTip="Speed Override">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <TextBlock Text="OV" Foreground="#555555" FontSize="9" HorizontalAlignment="Center"/>
                                <TextBlock Foreground="#222222" FontSize="11" FontWeight="Bold"
                                           HorizontalAlignment="Center" Margin="0,1,0,0">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0:F0}%">
                                            <Binding Path="SpeedOverride"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <!-- Incremental Jog Mode -->
                        <Border Background="#D8D8D8" BorderBrush="#999999" BorderThickness="0,0,0,1"
                                Height="44" Margin="2,0,2,1" ToolTip="Incremental Jog">
                            <TextBlock Text="{Binding IncrementalJogMode}" Foreground="#222222" FontSize="14"
                                       FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- ============================================================ -->
        <!-- ROW 3: BOTTOM SOFTKEYS (Modular UserControl)                 -->
        <!-- ============================================================ -->
        <layout:BottomSoftkeyBarView Grid.Row="3"/>

        <!-- ============================================================ -->
        <!-- DIALOG: New Program (overlay)                                -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" Grid.RowSpan="4"
                Background="#80000000"
                Visibility="{Binding ShowNewProgramDialog, Converter={StaticResource BoolToVisibility}}">
            <Border Background="#CCCCCC" BorderBrush="#999999" BorderThickness="2"
                    Width="400" Height="260"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    SnapsToDevicePixels="True">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="New Program"
                               FontSize="18" FontWeight="Bold"
                               Foreground="#222222" Margin="0,0,0,12" FontFamily="Segoe UI"/>
                    <Grid Grid.Row="1" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Name:" Foreground="#555555" FontSize="13"
                                   VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding NewProgramName, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#FFFFFF" Foreground="#222222" BorderBrush="#999999"
                                 FontSize="14" Padding="6,4" FontFamily="Consolas"/>
                    </Grid>
                    <Grid Grid.Row="2" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Desc:" Foreground="#555555" FontSize="13"
                                   VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding NewProgramDescription, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#FFFFFF" Foreground="#222222" BorderBrush="#999999"
                                 FontSize="14" Padding="6,4" FontFamily="Consolas"/>
                    </Grid>
                    <StackPanel Grid.Row="4" Orientation="Horizontal"
                                HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button Content="Cancel" Width="80" Height="36"
                                Margin="0,0,10,0"
                                Style="{StaticResource IndustrialButton}"
                                Command="{Binding CancelNewProgramCommand}"/>
                        <Button Content="Create" Width="100" Height="36"
                                Background="#0078D7" Foreground="White"
                                BorderThickness="0" FontWeight="Bold" Cursor="Hand"
                                Command="{Binding ConfirmNewProgramCommand}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- ============================================================ -->
        <!-- DIALOG: Delete Program Confirmation (overlay)                -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" Grid.RowSpan="4"
                Background="#80000000"
                Visibility="{Binding ShowDeleteConfirmDialog, Converter={StaticResource BoolToVisibility}}">
            <Border Background="#CCCCCC" BorderBrush="#999999" BorderThickness="2"
                    Width="380" Height="180"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    SnapsToDevicePixels="True">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Delete Program?"
                               FontSize="18" FontWeight="Bold"
                               Foreground="#222222" Margin="0,0,0,10" FontFamily="Segoe UI"/>
                    <TextBlock Grid.Row="1" TextWrapping="Wrap" Foreground="#555555" FontFamily="Segoe UI">
                        <Run Text="Are you sure you want to delete "/>
                        <Run Text="{Binding DeleteTargetName, Mode=OneWay}" Foreground="#FFAA00" FontWeight="Bold"/>
                        <Run Text="? This action cannot be undone."/>
                    </TextBlock>
                    <StackPanel Grid.Row="2" Orientation="Horizontal"
                                HorizontalAlignment="Right" Margin="0,15,0,0">
                        <Button Content="Cancel" Width="80" Height="36"
                                Margin="0,0,10,0"
                                Style="{StaticResource IndustrialButton}"
                                Command="{Binding CancelDeleteCommand}"/>
                        <Button Content="Delete" Width="100" Height="36"
                                Background="#CC0000" Foreground="White"
                                BorderThickness="0" FontWeight="Bold" Cursor="Hand"
                                Command="{Binding ConfirmDeleteCommand}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- ============================================================ -->
        <!-- DIALOG: Rename Program (overlay)                             -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" Grid.RowSpan="4"
                Background="#80000000"
                Visibility="{Binding ShowRenameDialog, Converter={StaticResource BoolToVisibility}}">
            <Border Background="#CCCCCC" BorderBrush="#999999" BorderThickness="2"
                    Width="380" Height="180"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    SnapsToDevicePixels="True">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Rename Program"
                               FontSize="18" FontWeight="Bold"
                               Foreground="#222222" Margin="0,0,0,12" FontFamily="Segoe UI"/>
                    <Grid Grid.Row="1" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Name:" Foreground="#555555" FontSize="13"
                                   VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding RenameProgramName, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#363636" Foreground="#222222" BorderBrush="#5A5A5A"
                                 FontSize="14" Padding="6,4" FontFamily="Consolas"/>
                    </Grid>
                    <StackPanel Grid.Row="3" Orientation="Horizontal"
                                HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button Content="Cancel" Width="80" Height="36"
                                Margin="0,0,10,0"
                                Style="{StaticResource IndustrialButton}"
                                Command="{Binding CancelRenameCommand}"/>
                        <Button Content="Rename" Width="100" Height="36"
                                Background="#0078D7" Foreground="White"
                                BorderThickness="0" FontWeight="Bold" Cursor="Hand"
                                Command="{Binding ConfirmRenameCommand}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- ============================================================ -->
        <!-- DIALOG: STM32 Connect (overlay)                              -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" Grid.RowSpan="4"
                Background="#80000000"
                Visibility="{Binding ShowStm32ConnectDialog, Converter={StaticResource BoolToVisibility}}">
            <Border Background="#CCCCCC" BorderBrush="#999999" BorderThickness="2"
                    Width="400" Height="260"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    SnapsToDevicePixels="True">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Connect STM32 (Ethernet)"
                               FontSize="18" FontWeight="Bold"
                               Foreground="#222222" Margin="0,0,0,12" FontFamily="Segoe UI"/>
                    <Grid Grid.Row="1" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="IP:" Foreground="#555555" FontSize="13"
                                   VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding Stm32IpAddress, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#363636" Foreground="#222222" BorderBrush="#5A5A5A"
                                 FontSize="14" Padding="6,4" FontFamily="Consolas"/>
                    </Grid>
                    <Grid Grid.Row="2" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Port:" Foreground="#555555" FontSize="13"
                                   VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding Stm32Port, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#363636" Foreground="#222222" BorderBrush="#5A5A5A"
                                 FontSize="14" Padding="6,4" FontFamily="Consolas"/>
                    </Grid>
                    <TextBlock Grid.Row="3" Text="{Binding Stm32StatusText}"
                               Foreground="#FFD700" FontSize="12" Margin="0,0,0,4"
                               FontFamily="Segoe UI"/>
                    <StackPanel Grid.Row="5" Orientation="Horizontal"
                                HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button Content="Cancel" Width="80" Height="36"
                                Margin="0,0,10,0"
                                Style="{StaticResource IndustrialButton}"
                                Command="{Binding CancelStm32ConnectCommand}"/>
                        <Button Content="Connect" Width="100" Height="36"
                                Background="#1B5E20" Foreground="White"
                                BorderThickness="0" FontWeight="Bold" Cursor="Hand"
                                Command="{Binding ConfirmStm32ConnectCommand}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- E-STOP Reset Confirmation Dialog (overlay) -->
        <Border Grid.Row="0" Grid.RowSpan="4"
                Background="#80000000"
                Visibility="{Binding ShowEStopConfirmDialog, Converter={StaticResource BoolToVisibility}}">
            <Border Background="#CCCCCC" BorderBrush="#999999" BorderThickness="2"
                    Width="380" Height="200"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    SnapsToDevicePixels="True">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Reset E-STOP?"
                               FontSize="18" FontWeight="Bold"
                               Foreground="#222222" Margin="0,0,0,10" FontFamily="Segoe UI"/>
                    <TextBlock Grid.Row="1" TextWrapping="Wrap" Foreground="#555555" FontFamily="Segoe UI">
                        <Run Text="E-STOP is currently active. "/>
                        <Run Text="Please verify all hazards are clear before resetting." Foreground="#FFAA00"/>
                    </TextBlock>
                    <StackPanel Grid.Row="2" Orientation="Horizontal"
                                HorizontalAlignment="Right" Margin="0,15,0,0">
                        <Button Content="Cancel" Width="80" Height="36"
                                Margin="0,0,10,0"
                                Style="{StaticResource IndustrialButton}"
                                Command="{Binding CancelEStopResetCommand}"/>
                        <Button Content="Reset E-STOP" Width="120" Height="36"
                                Command="{Binding ResetEStopCommand}">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#008800"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="bd" Background="{TemplateBinding Background}"
                                                        Padding="8,4" SnapsToDevicePixels="True">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="bd" Property="Background" Value="#00AA00"/>
                                                    </Trigger>
                                                    <Trigger Property="IsPressed" Value="True">
                                                        <Setter TargetName="bd" Property="Background" Value="#006600"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>
    </Grid>
</Window>
